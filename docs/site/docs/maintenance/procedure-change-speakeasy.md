# Procedure: Regenerate Speakeasy-Manged Code

Speakeasy-managed portions of the `opa-java` SDK are normally kept upt to date by [SDK generation workflow](https://github.com/StyraInc/opa-java/blob/main/.github/workflows/sdk_generation.yaml). Usually, no additional actions are required beyond merging the PRs this workflow creates automatically. For more information, see [*Procedure: Release*](./procedure-release.md).

If you need to re-generate the Speakeasy portions of the code manually, you can use the following shell commands:

```sh
speakeasy run --skip-compile --force
./scripts/post-generate-hook.sh
```

Subsequently, you should use `./gradlew test` and `./gradlew lint` to ensure that the changes did not cause any regressions.

!!! note

    If you commit changes generated using this manual procedure, it may prevent the SDK generation workflow from detecting them as changes, which may in turn prevent the release workflow from triggering automatically.

## Understanding Styra-Managed `build.gradle` Changes

The `build.gradle` file generated by `speakeasy run` is unsuitable for use with the `opa-java` project out of the box; several additional tasks and plugins need to be added. It does have some Speakeasy-managed information in it that is required though, namely any updated dependencies and their versions. As a workaround a shell script is used to post-process the `build.gradle` which Speakeasy generates with additional Styra-managed modifications. This script has been appropriately connected to the GitHub Actions workflow for Speakeasy "chore" PRs, thus it should not normally need to be run manually.

As a matter of convention, all post-generate modifications that are carried out automatically are kicked off by invoking [`scripts/post-generate-hook.sh`](https://github.com/StyraInc/opa-java/blob/main/scripts/post-generate-hook.sh), although at time of writing this script only calls `fix-build-gradle.sh`.

The script [`scripts/fix-build-gradle.sh`](https://github.com/StyraInc/opa-java/blob/main/scripts/fix-build-gradle.sh) performs the necessary modifications to `build.gradle` and `settings.gradle`. These changes include:

* The `plugins { ... }` block is replaced with the one in [`scripts/build-plugins.gradle`](https://github.com/StyraInc/opa-java/blob/main/scripts/build-plugins.gradle).
* The file [`scripts/build-footer.gradle`](https://github.com/StyraInc/opa-java/blob/main/scripts/build-footer.gradle) is appended to the end of `build.gradle`; the string `=== build-footer ===` is used as a sigil to ensure this operation is idempotent.
* The root project name in `settings.gradle` is changed from `openapi` to `opa`.
* The group and artifact IDs in `build.gradle` used for release publishing are changed from `com.styra.opa` and `openapi` to `com.styra` and `opa` respectively.
* `./gradlew fixGradleLint` to prevent the Gradle linter from complaining later about any unused dependencies added.

`post-generate-hook.sh`, and everything it calls, is designed to be idempotent, so you may run it as many times as you wish without any adverse effects. At time of writing, there is a known bug where an extra newline is added after the closing `}` of the `plugins` block, but that does not impact how Gradle interprets the file.

As a safety feature for the potentially messy process of changing the group and artifact IDs, the `fix-build-gradle.sh` script will also attempt to lint for suspicious strings that may indicate an incorrectly rewritten group or artifact ID. In this situation, it will print the warning `WARNING: possible incorrect group/artifact ID rewrite`. If this occurs, `fix-build-gradle.sh` needs manual intervention to update it, as the Speakeasy generation of `build.gradle` has presumably changed.

